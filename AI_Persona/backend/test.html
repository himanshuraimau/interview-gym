<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice AI Interviewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .interviewer-preview {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .interviewer-preview h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .interviewer-preview p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .expertise-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
        }

        .connect-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connect-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .connect-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .status.disconnected {
            background: #fee;
            color: #c33;
        }

        .status.connected {
            background: #efe;
            color: #3c3;
        }

        .status.connecting {
            background: #fef3cd;
            color: #856404;
        }

        .controls {
            display: none;
            text-align: center;
            margin-top: 30px;
        }

        .ptt-button {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0 auto;
            display: block;
        }

        .ptt-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .ptt-button.speaking {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: scale(0.95);
        }

        .ptt-button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        .instructions {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 500;
        }

        /* Transcript Styles */
        .transcript-container {
            margin: 30px 0;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .transcript-container h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .transcript {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .message {
            margin: 12px 0;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.interviewer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 4px;
        }

        .message-text {
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.8;
        }

        .message-method {
            font-size: 10px;
            opacity: 0.7;
            font-style: italic;
        }

        /* Chat Input Styles */
        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        #chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéôÔ∏è Voice AI Interviewer</h1>
        <p class="subtitle">Select your interviewer and start practicing</p>

        <div id="status" class="status disconnected">‚ö†Ô∏è Disconnected</div>

        <div id="setup-form">
            <!-- Interviewer Selection -->
            <div class="section">
                <div class="section-title">1. Select Interviewer</div>
                <div class="form-group">
                    <label for="interviewer-select">Choose Interview Type:</label>
                    <select id="interviewer-select">
                        <option value="">Loading interviewers...</option>
                    </select>
                </div>
                <div id="interviewer-preview" class="interviewer-preview" style="display: none;"></div>
            </div>

            <!-- User Profile -->
            <div class="section">
                <div class="section-title">2. Your Profile</div>
                <div class="form-group">
                    <label for="user-name">Name:</label>
                    <input type="text" id="user-name" value="Alex Johnson" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label for="user-experience">Experience:</label>
                    <input type="text" id="user-experience" value="4 years" placeholder="e.g., 3 years">
                </div>
                <div class="form-group">
                    <label for="user-skills">Skills (comma-separated):</label>
                    <input type="text" id="user-skills" value="React, TypeScript, Node.js, PostgreSQL"
                        placeholder="e.g., Python, Django, AWS">
                </div>
                <div class="form-group">
                    <label for="user-role">Target Role:</label>
                    <input type="text" id="user-role" value="Senior Software Engineer"
                        placeholder="e.g., Senior Backend Engineer">
                </div>
            </div>

            <!-- Connect Button -->
            <button id="connect-button" class="connect-button" disabled>
                Select an interviewer to continue
            </button>
        </div>

        <!-- Conversation Transcript (hidden initially) -->
        <div id="transcript-container" class="transcript-container" style="display: none;">
            <h3>Interview Conversation</h3>
            <div id="transcript" class="transcript"></div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <textarea id="chat-input" placeholder="Type your answer here (optional)..." rows="2"></textarea>
                <button id="send-text-button" class="send-button">Send</button>
            </div>
        </div>

        <!-- Interview Controls (hidden initially) -->
        <div id="controls" class="controls">
            <button id="ptt-button" class="ptt-button" disabled>
                Hold to<br>Speak
            </button>
            <p class="instructions">
                Press and hold the button to speak.<br>
                Release when you're done.
            </p>
            <button id="disconnect-button" class="disconnect-button">
                End Interview
            </button>
        </div>
    </div>

    <!-- Load LiveKit Client Library -->
    <script src="http://localhost:3001/libs/livekit-client.umd.min.js"></script>

    <script>
        // Wait for LiveKit to load
        if (typeof LivekitClient === 'undefined') {
            console.error('LiveKit library failed to load!');
            alert('Error: LiveKit library failed to load. Please refresh the page.');
        }

        const API_URL = 'http://localhost:3001';
        let room = null;
        let interviewers = [];
        let selectedInterviewer = null;

        // Load interviewers on page load
        async function loadInterviewers() {
            try {
                const response = await fetch(`${API_URL}/api/interviewers`);
                const data = await response.json();
                interviewers = data.interviewers;

                const select = document.getElementById('interviewer-select');
                select.innerHTML = '<option value="">-- Select an interviewer --</option>';

                interviewers.forEach(interviewer => {
                    const option = document.createElement('option');
                    option.value = interviewer.id;
                    option.textContent = interviewer.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load interviewers:', error);
                document.getElementById('interviewer-select').innerHTML =
                    '<option value="">Error loading interviewers. Is the API running?</option>';
            }
        }

        // Update interviewer preview
        function updateInterviewerPreview(interviewerId) {
            const interviewer = interviewers.find(i => i.id === interviewerId);
            if (!interviewer) return;

            selectedInterviewer = interviewer;
            const preview = document.getElementById('interviewer-preview');
            preview.style.display = 'block';
            preview.innerHTML = `
                <h3>${interviewer.name}</h3>
                <p><strong>Role:</strong> ${interviewer.role}</p>
                <p><strong>Style:</strong> ${interviewer.interviewStyle}</p>
                <p><strong>Duration:</strong> ${interviewer.duration} minutes</p>
                <p><strong>Phases:</strong> ${interviewer.phases.join(' ‚Üí ')}</p>
                <div class="expertise-tags">
                    ${interviewer.expertise.map(e => `<span class="tag">${e}</span>`).join('')}
                </div>
            `;

            document.getElementById('connect-button').disabled = false;
            document.getElementById('connect-button').textContent = `Start ${interviewer.name}`;
        }

        // Generate token and connect
        async function connectToInterview() {
            const statusEl = document.getElementById('status');
            const connectBtn = document.getElementById('connect-button');

            try {
                statusEl.className = 'status connecting';
                statusEl.textContent = 'üîÑ Generating token and connecting...';
                connectBtn.disabled = true;

                // Get user profile
                const userProfile = {
                    name: document.getElementById('user-name').value,
                    experience: document.getElementById('user-experience').value,
                    skills: document.getElementById('user-skills').value.split(',').map(s => s.trim()),
                    targetRole: document.getElementById('user-role').value,
                };

                // Generate token via API
                const response = await fetch(`${API_URL}/api/generate-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interviewerId: selectedInterviewer.id,
                        userProfile,
                    }),
                });

                const { token, url } = await response.json();

                // Connect to LiveKit room
                room = new LivekitClient.Room();

                // Handle incoming audio tracks from the agent
                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    console.log('üì• Track received:', track.kind, 'from', participant.identity);
                    if (track.kind === 'audio') {
                        const audioElement = track.attach();
                        console.log('üîä Audio element created:', audioElement);
                        audioElement.play()
                            .then(() => console.log('‚úÖ Audio playing successfully'))
                            .catch(err => console.error('‚ùå Audio play failed:', err));
                    }
                });

                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
                    console.log('üì§ Track unsubscribed:', track.kind);
                });

                room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
                    console.log('üë§ Participant connected:', participant.identity);
                });

                console.log('üîå Connecting to room...');
                await room.connect(url, token);
                console.log('‚úÖ Connected to room:', room.name);
                console.log('üìä Room state:', {
                    participants: room.remoteParticipants.size,
                    localParticipant: room.localParticipant.identity
                });

                // Wait a bit and check again
                setTimeout(() => {
                    console.log('üìä Room state after 3s:', {
                        participants: room.remoteParticipants.size,
                        participantsList: Array.from(room.remoteParticipants.values()).map(p => p.identity)
                    });
                }, 3000);

                statusEl.className = 'status connected';
                statusEl.textContent = '‚úÖ Connected - Interview in progress';

                // Show controls, hide form
                document.getElementById('setup-form').style.display = 'none';
                document.getElementById('controls').style.display = 'block';

                // Enable PTT button
                const pttButton = document.getElementById('ptt-button');
                pttButton.disabled = false;

                // Setup PTT functionality
                setupPushToTalk(pttButton);

            } catch (error) {
                console.error('Connection error:', error);
                statusEl.className = 'status disconnected';
                statusEl.textContent = '‚ùå Connection failed: ' + error.message;
                connectBtn.disabled = false;
            }
        }

        // Setup push-to-talk
        function setupPushToTalk(button) {
            let isPublishing = false;

            button.addEventListener('mousedown', async () => {
                if (isPublishing) return;
                isPublishing = true;
                button.classList.add('speaking');

                try {
                    await room.localParticipant.setMicrophoneEnabled(true);
                } catch (error) {
                    console.error('Failed to enable microphone:', error);
                }
            });

            button.addEventListener('mouseleave', async () => {
                if (!isPublishing) return;
                isPublishing = false;
                button.classList.remove('speaking');

                try {
                    await room.localParticipant.setMicrophoneEnabled(false);
                } catch (error) {
                    console.error('Failed to disable microphone:', error);
                }
            });
        }

        // Event listeners
        document.getElementById('interviewer-select').addEventListener('change', (e) => {
            if (e.target.value) {
                updateInterviewerPreview(e.target.value);
            } else {
                document.getElementById('interviewer-preview').style.display = 'none';
                document.getElementById('connect-button').disabled = true;
                document.getElementById('connect-button').textContent = 'Select an interviewer to continue';
            }
        });

        document.getElementById('connect-button').addEventListener('click', connectToInterview);

        // Load interviewers on page load
        loadInterviewers();
    </script>
</body>

</html>